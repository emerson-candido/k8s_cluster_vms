---
- hosts: "{{ node_prefix }}-{{ node_count }}"
  become: true
  gather_facts: yes
  tasks:
  - name: Install ingress
    include_role:
      name: ingress
      tasks_from: install
    when: ingress_deploy == "yes"
  
  - name: Install cert_manager
    include_role:
      name: cert_manager
      tasks_from: install
    when: cert_manager_deploy == "yes"

  - name: Install Longhorn
    block:
    - name: Add LVM Volumes
      include_role:
        name: lvm
        tasks_from: add_lvm_volumes

    - name: Install Longhorn
      include_role:
        name: longhorn
        tasks_from: install
    when: longhorn_deploy == "yes"
    
  - name: Install monitoring stack
    block:
    - name: Install kube-prometheus-stack
      include_role:
        name: monitoring
        tasks_from: kube-prometheus-stack
    
    - name: Install pushgateway
      include_role:
        name: monitoring
        tasks_from: pushgateway
    when: monitoring_deploy == "yes"
    
  - name: Install gatekeeper
    include_role:
      name: gatekeeper
      tasks_from: install
    when: gatekeeper_deploy == "yes"