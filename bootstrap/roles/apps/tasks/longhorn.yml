---
- name: LVM Volumes
  block:
  - name: Install LVM
    ansible.builtin.apt: 
      name: "{{ packages }}"
      state: present
      update_cache: yes
    vars:
      packages:
      - python-software-properties
      - xfsprogs
      - lvm2

  - name: Create Volume Group
    community.general.lvg:
      vg: "{{ disk_name }}"
      pvs: "/dev/{{ disk_device }}"
      pvresize: yes

  - name: Create the Logical Volume
    community.general.lvol:
      lv: "{{ disk_name }}-{{ disk_device }}"
      vg: "{{ disk_name }}"
      size: "{{ disk_size | int -1 }}G"
      state: present

  - name: creating new filesystem on new LVM logical volume
    community.general.filesystem:
      fstype: "{{ disk_fs }}"
      dev: /dev/{{ disk_name }}/{{ disk_name }}-{{ disk_device }}

  - name: Mounting new filesystem
    ansible.posix.mount:
      path: "{{ disk_directory }}"
      src: /dev/{{ disk_name }}/{{ disk_name }}-{{ disk_device }}
      fstype: "{{ disk_fs }}"
      state: mounted

- name: Longhorn
  block:
  - name: Install Longhorn Required Packages
    ansible.builtin.apt:
      name: "{{ packages }}"
      state: present
      update_cache: yes
    vars:
      packages:
      - open-iscsi
      - nfs-common

  - name: Install Longhorn
    kubernetes.core.helm:
      name: "longhorn"
      chart_ref: "longhorn"
      chart_version: "{{ longhorn_chart_version }}"
      chart_repo_url: "https://charts.longhorn.io"
      release_namespace: longhorn
      create_namespace: true
      values:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        ingress:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: nginx
            nginx.ingress.kubernetes.io/rewrite-target: /$2
          path: '/longhorn(/|$)(.*)'
    become: false
    delegate_to: "localhost"