---
- name: Install kube-prometheus-stack
  kubernetes.core.helm:
    name: "kube-prometheus-stack"
    chart_ref: "kube-prometheus-stack"
    chart_version: "{{ kube_prometheus_stack_chart_version }}"
    chart_repo_url: "https://prometheus-community.github.io/helm-charts"
    release_namespace: monitoring
    create_namespace: true
    values:
      alertmanager:
        enabled: true
        ingress:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: nginx
            nginx.ingress.kubernetes.io/rewrite-target: /$2
          paths: ['/alertmanager(/|$)(.*)']
      grafana:
        enabled: true
        env:
          GF_SERVER_ROOT_URL: /grafana
          GF_SERVER_SERVE_FROM_SUB_PATH: 'true'
        ingress:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: nginx
            nginx.ingress.kubernetes.io/rewrite-target: /$2
          path: "/grafana(/|$)(.*)"
          pathType: Prefix
      prometheus:
        enabled: true
        ingress:
          enabled: true
          paths: ['/prometheus']
          pathType: Prefix
          annotations:
            kubernetes.io/ingress.class: nginx
        prometheusSpec:
          routePrefix: '/prometheus/'
          externalUrl: 'http://0.0.0.0:30080/prometheus/'
  become: false
  delegate_to: "localhost"