---
- name: Install kube-prometheus-stack
  kubernetes.core.helm:
    name: "kube-prometheus-stack"
    chart_ref: "kube-prometheus-stack"
    chart_version: "{{ kube_prometheus_stack_chart_version }}"
    chart_repo_url: "https://prometheus-community.github.io/helm-charts"
    release_namespace: monitoring
    create_namespace: true
    values:
      alertmanager:
        enabled: true
        service:
          type: NodePort
          nodePort: 30009
      grafana:
        enabled: true
        service:
          type: NodePort
          nodePort: 30010
      prometheus:
        enabled: true
        service:
          type: NodePort
          nodePort: 30008
  become: false
  delegate_to: "localhost"
  when: node_numbers == node_count